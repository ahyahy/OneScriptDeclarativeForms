<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML><HEAD><TITLE>DeclarativeForms</TITLE>
<META content="text/html; charset=Windows-1252" http-equiv="Content-Type">
<META name="keywords" content="OneScript, DeclarativeForms, 1С">
<LINK rel="stylesheet" type="text/css" href="mainstyle.css">
</HEAD>
<BODY id=bodyID class=dtBODY>
<DIV id=nsbanner>
<DIV id=bannerrow1>
<TABLE class=bannerparthead cellSpacing=0>
  <TBODY>
  <TR id=hdr>
    <TD class=runninghead></TD>
    <TD class=product></TD></TR></TBODY></TABLE></DIV>
<DIV id=TitleRow>
<H1 class=dtH1>Библиотека DeclarativeForms</H1></DIV></DIV>
<DIV id=nstext>
<br>
<H3 class=dtH3>Назначение</H3>
<br>
<P>Декларативные формы задумывались как десктопное приложение на базе веб-технологий, со всеми возможностями движка Chrome. 
Изначально требования к приложению ставились следующие:</P>
<DIV style="margin-left: 40px;">
	<li>Нужна программа с браузером в окне, но не браузер с нашей программой.</li>
	<li>Нужен простой код создания и управления элементами и простая обработка событий. Что то вроде 
<PRE class=code>
Кнопка1 = ДФ.Кнопка();
Кнопка1.Родитель = Форма1;
Кнопка1.Текст = "Кнопка";
Кнопка1.Нажатие = ДФ.Действие(ЭтотОбъект, "Кнопка1_Нажатие");
</PRE>
	</li>
	<li>Запуск на любой платформе где можно запустить браузер Chrome.</li>
	<li>Избежать необходимости изучать дополнительные фреймворки.</li>
	<li>Приложение должно работать в фоне, запускаться при старте системы и оффлайн.</li>
	<li>Версия браузера определяется пользователем, а не системой.</li>
	<li>Возможность создания меню, нескольких окон, иконки в трее (менюбаре), управление ими.</li>
	<li>Возможность режима kiosk-mode (как в десктопных играх) и для создания презентаций в том числе.</li>
</DIV>
<P>В первую очередь это инструмент в помощь разработчикам на языке 1С. Используются два движка - 
<A href="https://oscript.io/" target="_blank">OneScript</A> и <A href="https://nwjs.io/" target="_blank">NW.JS</A>.</P>
<P><B>OneScript</B> повторяет синтаксис 1С, поэтому тем, кто с ним знаком дополнительно ничего изучать не нужно.</P>
<P><B>NW.JS</B> обеспечивает кроссплатформенность, так как может создать окно программы с браузером в этом окне. Его изучать не нужно, 
механизм его работы и взаимодействия со сценарием скрыт внутри библиотеки декларативных форм.</P>
<br>
<H3 class=dtH3>Требования к каталогу Вашей программы.</H3>
<br>
<P>Минимальные требования к устройству каталога Вашей программы при первом запуске показаны на рисунке ниже.</P>
<style>img { border: 3px solid #808080; }</style>
<IMG src="Intro1.jpg"></IMG>
<br>
<P></P>
<P>Имя стартового сценария не регламентируется. В этой справке стартовый сценарий будет называться <B>Стартовый.os</B>.</P>
<P>Содержимое файла <B>Стартовый.os</B> следующее:</P>
<PRE class=code>
ПодключитьВнешнююКомпоненту("ВашКаталогНаДиске\DeclarativeForms.dll");
ДФ = Новый ДекларативныеФормы();
ДФ.nwПуть = "C:\222\nwjs\nw.exe";

Форма1 = ДФ.Форма;
Форма1.Открыть();
</PRE>
<P>Пути указаны с моего компьютера. Переменная <B>ДФ.nwПуть</B> указывают куда программе обратиться за движком <B>NWJS</B>.</P>
<P>Но можно упростить дело и поместить каталог <B>NWJS</B> рядом со стартовым скриптом.</P>
<P></P>
<IMG src="Intro2.jpg"></IMG>
<P></P>
<br>
<P>После запуска <B>Стартовый.os</B> в каталог будут дозаписаны необходимые файлы и программа сразу начнет работать.</P>
<P>Дозаписаны будут файлы 
<br>
<B>index.html</B> - стартовая страница-шаблон формы и 
<br>
<B>package.json</B> - настройки для <B>NWJS</B>.</P>
<br>
<P></P>
<IMG src="Intro3.jpg"></IMG>
<P></P>
<P>Без TCP сервера невозможна связь формы с нашим сценарием. Многопоточный TCP сервер внедрен  в библиотеку декларативных форм и будет запущен автоматически в фоновом задании.</P>
<P> Код сценария сократится до:</P>
<PRE class=code>
ПодключитьВнешнююКомпоненту("ВашКаталогНаДиске\DeclarativeForms.dll");
ДФ = Новый ДекларативныеФормы();

Форма1 = ДФ.Форма;
Форма1.Открыть();
</PRE>
<P></P>
<br>
<H3 class=dtH3>Подключение библиотеки и создание объекта ДекларативныеФормы.</H3>
<br>
<P>Подключить библиотеку можно так:</P>
<PRE class=code>
ПодключитьВнешнююКомпоненту("ВашКаталогНаДиске\DeclarativeForms.dll");
ДФ = Новый ДекларативныеФормы();
</PRE>
<P>При создании объекта ДекларативныеФормы автоматически выполнится метод <B>ДФ.ЗагрузитьСценарии(".\")</B> и подключатся сценарии находящиеся в 
подкаталогах <B>Классы</B> и <B>Модули</B>. В подключенных сценариях будет доступна структура под именем <B>ОбщаяСтруктура</B>. И у <B>ОбщаяСтруктура</B> 
будет свойство с именем <B>ДФ</B>. Так что Вы можете в подключенном сценарии сразу обратиться к объекту <B>ДекларативныеФормы</B> так:</P>
<PRE class=code>
Сообщить("из сценария ОбщаяСтруктура.ДФ = " + ОбщаяСтруктура.ДФ);
</PRE>
<br>
<H3 class=dtH3>Закрытие программы.</H3>
<br>
<P>После запуска стартового сценария откроется окно консоли и затем окно программы. Взаимодействовать они будут через запущенный фоновым заданием TCP сервер. 
Запуск TCP сервера производится автоматически. Корректное закрытие всех запущенных 
модулей - это закрытие окна программы. Это вызовет завершение работы и <B>NW.JS</B>  и фонового TCP сервера и окна консоли.</P>
<P>Если закрыть только окно консоли это вызовет и завершение фонового TCP сервера, но окно программы останется открытым и может выдать сообщение о потере связи с сервером, 
после чего может автоматически закрыться. Возможно закрытия и не произойдет, зависит от кода программы. Следующий запуск стартового сценария будет успешным только 
после закрытия окна программы.</P>
<P>Избежать появление окна консоли совсем поможет разработка <A href="https://github.com/ahyahy/OneScriptNoConsole" target="_blank">Запуск сценариев OneScript без окна консоли</A>.</P>
<P></P>
<br>
<H3 class=dtH3>Как происходит обработка событий в ОС Linux.</H3>
<br>
<P>Декларативные формы выполнены в парадигме событийно-ориентированного программирования. С одной стороны у нас движок <B>NW.JS</B>, который по нашему плану 
создал окно с движком браузера <B>Chromium</B> в пределах окна. С другой стороны сценарий, работающий на движке <B>OneScript</B>. Связь между ними происходит 
посредством <B>TCP сервера</B>, запущенного фоновым процессом. При возникновении в форме события выполняется соответствующая функция из 
скрипта js в файле <B>index.html</B>. Функция формирует <B>HTTP-запрос</B> для <B>TCP сервера</B>. <B>TCP сервер</B> анализирует этот запрос, находит указанный 
обработчик в сценарии и выполняет его. Затем высылает клиенту ответ. В этом ответе в виде строки собраны все действия возникшие во время выполнения обработчика 
на стороне сценария. 
Действия эти представлены функциями с параметрами. Функции разделены уникальной последовательностью символов. Получив в ответ на <B>HTTP-запрос</B> строку с перечнем функций 
скрипт js в файле <B>index.html</B> выполняет их, что вызывает изменения в форме.</P>
<P>Строка ответа сервера может быть просмотрена в любое время, она доступна в свойстве 
<B>ДекларативныеФормы.СтрокаФункций&nbsp;(DeclarativeForms.FunctionString)</B>. И её можно изменить, повлияв на ответ сервера по своему усмотрению.</P>
<P>Из всего этого ясно, что изменять форму в ответ на возникающие события мы можем только во время выполнения <B>HTTP-запроса</B>. Первый такой запрос 
производится при выполнении метода <B>Форма.Открыть&nbsp;(Form.Open)</B>. До его запуска идет код создания объектов формы, задания свойств. Эти действия 
записываются в свойство <B>ДекларативныеФормы.СтрокаФункций&nbsp;(DeclarativeForms.FunctionString)</B>. С запуском метода <B>Форма.Открыть&nbsp;(Form.Open)</B> 
<B>NW.JS</B> формирует окно и срабатывает событие загрузки страницы <B>index.html</B>. В этом событии посылается первый запрос на сервер. Сервер в ответе высылает 
строку <B>ДекларативныеФормы.СтрокаФункций&nbsp;(DeclarativeForms.FunctionString)</B> функции из которой выполняются друг за другом. Создаются объекты формы и 
устанавливаются их свойства.</P>
<P>Мы не можем изменять состояние формы непосредственно при каждом атомарном изменении свойств объектов в сценарии. 
Форма может только пакетом получить сделанные изменения и только в пределах выполнения обработчика события. Сервер закрывает соединение после отсылки ответа 
клиенту, иначе <B>HTTP-запрос</B> не будет получен клиентом. Было бы лучше иметь возможность влиять на состояние формы 
не только при обработке события, но и в произвольном месте сценария. Для этого средствами <B>NW.JS</B> в файле <B>index.html</B> создается <B>TCP&nbsp;клиент</B>. 
Он подключается к серверу и создает постоянный канал связи. При случайном или намеренном разрыве канал восстанавливается. По нему можно так же посылать 
форме имена функций с параметрами и делать это можно не в пределах обработчика события. Сообщение форме можно послать 
методом <B>ДекларативныеФормы.СообщениеФорме&nbsp;(DeclarativeForms.MessageToForm)</B>. 
 <PRE class=code>
ДФ.СообщениеФорме("mapKeyEl.get('" + Кнопка2.КлючЭлемента + "').style['backgroundColor'] = 'rgb(175, 238, 238)'");
</PRE>
</P>
<P> Есть ограничение - такое возможно только после выполнения метода <B>Форма.Открыть&nbsp;(Form.Open)</B></P>
<P>Так как <B>TCP сервер</B> многопоточный выполнение событий будет происходить не в линейном порядке отправки <B>HTTP-запросов</B>. 
Оно будет зависеть от алгоритма работы сервера и выполнение строгой очередности здесь не наблюдается.</P>
<P></P>
<br>
<H3 class=dtH3>Как происходит обработка событий в ОС Windows.</H3>
<br>
<P>В ОС Windows для связи формы со сценарием используется объект WebSocket. Создаются два соединения WebSocket, которые запускаются фоновыми заданиями. 
Одино из этих соединений работает на прием сообщений от формы, другое на отправку сообщений от сценария к форме. Благодаря использованию WebSocket стала 
возможной работа сценария в браузере, установленном в системе по умолчанию. То есть без помощи разработки <B>NWJS</B>. 
В остальном обработка событий соответствует описанной для ОС Linux.</P>
<P></P>
<br>
<H3 class=dtH3>Как устанавливать значения свойств элементов и стилей.</H3>
<br>
<P>Для всех свойств предусмотрена возможность установки различными способами.</P>
	<li>Можно установить свойство согласно его описанному в справке типу значения. Для примера зададим границы для элемента <B>Блок&nbsp;(Div)</B>.
<PRE class=code>
Блок1.Стиль.Границы = ДФ.Границы(ДФ.ШиринаГраницы.Толстая, ДФ.СтильГраницы.Двойная, ДФ.Цвет(0, 0, 255));
</PRE>
	</li>
	<li>Можно установить свойство через тип значения <B>Строка</B>, применив синтаксис <B>js</B>.
<PRE class=code>
// Так
Блок1.Стиль.Границы = "thick solid #0000FF";
// или так
Блок1.Стиль.Границы = "thick solid rgb(0, 0, 255)";
</PRE>
	</li>
	<li>Можно применить файл стилей <B>css</B>, подключив его через свойство 
		<B>ДекларативныеФормы.cssПуть&nbsp;(DeclarativeForms.cssPath)</B>.
<PRE class=code>
ДФ.cssПуть = "styles.css";

// фрагмент из <B>styles.css</B>
// ...
border: thick solid #0000FF;
// ...
</PRE>
	</li>
<br>
<H3 class=dtH3>Управление размерностью свойств элементов и стилей.</H3>
<br>
<P>Размерность для числовых значений длины по умолчанию задается в пикселях <B>(px)</B>. Если необходимо использовать другую размерность, примените 
для установки строковый тип указав любую другую размерность.</P>
<PRE class=code>
Блок1.Стиль.Верх = 48; // пиксели

Блок1.Стиль.Верх = "2cm"; // сантиметры
// ...
</PRE>
<P>Этот прием действует для всех свойств имеющих размерность.</P>
<br>
<H3 class=dtH3>Применение файла стилей <B>css</B>.</H3>
<br>
<P>Иногда внешний вид элементов выглядит не так, как задумывает программист. Могут быть ограничены возможности движка браузера, используемого <B>NWJS</B>.</P>
<P>В этом случае можно изменить внешний вид элемента, описав его в файле стилей <B>css</B>. Пример приведен в справке в разделе <B>-Дополнения -Анимация куба</B>. 
Изменен внешний вид объектов <B>Ползунок&nbsp;(Range)</B>.</P>
<P></P>
<br>
<H3 class=dtH3>Запуск в окне браузера.</H3>
<br>
<P>Установив свойство <B>ДекларативныеФормы.ОткрытьВБраузере&nbsp;(DeclarativeForms.OpenInBrowser)</B> в значение <B>Истина</B> можно запустить формы в 
окне установленного в системе по умолчанию браузера. В этом случае нет необходимости в каталоге с <B>NWJS</B>, но функционал будет немного уменьшен. 
Это применимо только для ОС Windows.</P>
<P></P>
<P></P>
<P></P>
<br>
<P>.</P>
</DIV></BODY></HTML>
